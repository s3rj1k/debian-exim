From e5b942ae007d0533fbd599c64d550f3a8355b940 Mon Sep 17 00:00:00 2001
From: Jeremy Harris <jgh146exb@wizmail.org>
Date: Thu, 21 Mar 2019 20:01:03 +0000
Subject: [PATCH] Harden plaintext authenticator

Cherry-picked from: f9fc942757
---
 doc/ChangeLog     | 5 +++++
 src/auths/plaintext.c | 6 +-----
 2 files changed, 6 insertions(+), 5 deletions(-)

Index: BUILD/doc/ChangeLog
===================================================================
--- BUILD.orig/doc/ChangeLog
+++ BUILD/doc/ChangeLog
@@ -40,6 +40,11 @@ JH/10 OpenSSL: Fix aggregation of messag
       dropped connections and sometimes bounces generated by a peer sending
       to this system.
 
+JH/11 Harden plaintext authenticator against a badly misconfigured client-send
+      string.  Previously it was possible to cause undefined behaviour in a
+      library routine (usually a crash).  Found by "zerons".
+
+
 
 Exim version 4.92
 -----------------
Index: BUILD/src/auths/plaintext.c
===================================================================
--- BUILD.orig/src/auths/plaintext.c
+++ BUILD/src/auths/plaintext.c
@@ -223,11 +223,7 @@ while ((s = string_nextinlist(&text, &se
       if (ss[i+1] != '^')
 	ss[i] = 0;
       else
-        {
-        i++;
-        len--;
-        memmove(ss + i, ss + i + 1, len - i);
-        }
+        if (--len > ++i) memmove(ss + i, ss + i + 1, len - i);
 
   /* The first string is attached to the AUTH command; others are sent
   unembellished. */
